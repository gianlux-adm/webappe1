@model Ica.SalesOrders.Web.ViewModels.WarehouseIndexViewModel
@{
    ViewBag.Title = Html.Translate("Menu", "UserManagement");
}

<div id="searchForm">

    <div class="box filtro">
        <div class="box-header with-border">
            <h3 class="box-title">@Html.Translate("Shared", "Filter")</h3>
            <div class="box-tools pull-right">
                <button type="button" class="btn btn-box-tool" data-widget="collapse">
                    <i class="fa fa-minus"></i>
                </button>
            </div>
        </div>
        <!-- /.box-header -->
        <div class="box-body form-horizontal">

            <div class="row">
                <div class="col-sm-6 col-xs-12">
                    <label class="control-label">@Html.Translate("Warehouse", "Availability")</label>
                </div>
            </div>
            <div class="row">
                <div class="col-sm-6 col-xs-12">
                    @Html.DropDownListFor(m => m.Availability, new SelectList(Model.ValoriAvailability, "Key", "Value"), new { @class = "form-control" })
                    <input type="hidden" id="searchId" value="@Guid.NewGuid()" />
                </div>
            </div>

            <div class="row">
                <div class="col-sm-12 col-xs-12">
                    <label class="control-label">@Html.Translate("Warehouse", "ArticleCode")</label>
                </div>
            </div>

            <div class="row">
                <div class="col-sm-12 col-xs-12">
                    <div class="input-group input-group">
                        <div class="input-group-btn">
                            <button id="type_CodiceArticoloText"  data-type="0" type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-expanded="false">
                                @Html.Translate("Warehouse", "ArticleCode")
                                <span class="fa fa-caret-down"></span>
                            </button>
                            <ul class="dropdown-menu">
                                <li onclick="changeMode(this)" data-type="0"><a href="#">@Html.Translate("Warehouse", "ArticleCode")</a></li>
                                <li onclick="changeMode(this)" data-type="1"><a href="#">@Html.Translate("Warehouse", "Description")</a></li>
                            </ul> 
                        </div>
                        <div class="typeahead-container">
                            <div class="typeahead-field">
                                <span class="typeahead-query">
                                    <input type="text" id="CodiceArticoloText" class="form-control myText" autocomplete="off"  />
                                </span>
                            </div>
                        </div>
                        
                        <span class="input-group-addon" style="cursor: pointer;"><i class="fa fa-remove"></i></span>
                    </div>
                    
                    
                    <input type="hidden" id="CodiceArticolo" name="CodiceArticolo" value="@Model.CodiceArticolo" />
                </div>
            </div>

            <div class="row">
                <div class="col-md-3 col-sm-6 col-xs-12">
                    <label class="control-label">@Html.Translate("Warehouse", "Category1")</label>
                </div>
                <div class="col-md-3 col-sm-6 col-xs-12 hidden-xs">
                    <label class="control-label">@Html.Translate("Warehouse", "Category2")</label>
                </div>
                <div class="col-md-3 col-sm-6 col-xs-12 hidden-xs hidden-sm">
                    <label class="control-label">@Html.Translate("Warehouse", "Category3")</label>
                </div>
                <div class="col-md-3 col-sm-6 col-xs-12 hidden-xs hidden-sm">
                    <label class="control-label">@Html.Translate("Warehouse", "Category4")</label>
                </div>
            </div>

            <div class="row">
                <div class="col-md-3 col-sm-6 col-xs-12">
                    <div class="col-xs-11 col-md-11 col-sm-11 col-lg-11" style="padding-left:0px;padding-right:0px;">
                        @Html.DropDownListFor(m => m.Categoria1, new SelectList(Model.ValoriCategoria1, "Key", "Value"), Html.Translate("Shared", "All"), new { @class = "form-control" })
                    </div>
                    </div>
                    <div class="col-md-3 col-sm-6 col-xs-12 hidden-lg hidden-md hidden-sm">
                        <label class="control-label">@Html.Translate("Warehouse", "Category2")</label>
                    </div>
                    <div class="col-md-3 col-sm-6 col-xs-12">
                        <div class="col-xs-11 col-md-11 col-sm-11 col-lg-11" style="padding-left:0px;padding-right:0px;">
                            @Html.DropDownListFor(m => m.Categoria2, new SelectList(Model.ValoriCategoria2, "Key", "Value"), Html.Translate("Shared", "All"), new { @class = "form-control" })
                        </div>
                        <div class="col-xs-1 col-md-1 col-sm-1 col-lg-1" id="loading_cat_2" style="padding-left:0px;padding-right:0px;">

                        </div>
                    </div>
                    <div class="col-md-3 col-sm-6 col-xs-12 hidden-lg hidden-md">
                        <label class="control-label">@Html.Translate("Warehouse", "Category3")</label>
                    </div>
                    <div class="col-md-3 col-sm-6 col-xs-12 hidden-lg hidden-md hidden-xs">
                        <label class="control-label">@Html.Translate("Warehouse", "Category4")</label>
                    </div>
                    <div class="col-md-3 col-sm-6 col-xs-12">
                        <div class="col-xs-11 col-md-11 col-sm-11 col-lg-11" style="padding-left:0px;padding-right:0px;">
                            @Html.DropDownListFor(m => m.Categoria3, new SelectList(Model.ValoriCategoria3, "Key", "Value"), Html.Translate("Shared", "All"), new { @class = "form-control" })
                        </div>
                        <div class="col-xs-1 col-md-1 col-sm-1 col-lg-1" id="loading_cat_3" style="padding-left:0px;padding-right:0px;">

                        </div>
                    </div>
                    <div class="col-md-3 col-sm-6 col-xs-12 hidden-lg hidden-md hidden-sm">
                        <label class="control-label">@Html.Translate("Warehouse", "Category4")</label>
                    </div>
                    <div class="col-md-3 col-sm-6 col-xs-12">
                        <div class="col-xs-11 col-md-11 col-sm-11 col-lg-11" style="padding-left:0px;padding-right:0px;">
                            @Html.DropDownListFor(m => m.Categoria4, new SelectList(Model.ValoriCategoria4, "Key", "Value"), Html.Translate("Shared", "All"), new { @class = "form-control" })
                        </div>
                        <div class="col-xs-1 col-md-1 col-sm-1 col-lg-1" id="loading_cat_4" style="padding-left:0px;padding-right:0px;">

                        </div>
                    </div>
                </div>

            <div class="row">
                <div class="col-sm-6">

                </div>
                <div class="col-sm-6">
                    <button id="btn_search" type="button" class="btn btn-default" style="float:right">@Html.Translate("Shared", "Search")</button>
                </div>

            </div>




        </div>
    </div>

    <div id="results" style="display:none;">
        <div class="box filtro">
            <div class="box-header with-border">
                <h3 class="box-title">@Html.Translate("Warehouse", "Results")</h3>
            </div>
            <!-- /.box-header -->
            <div class="box-body form-horizontal">
                <table id="resultsTable" class="table table-striped table-bordered" style="width: 100% !important;">
                    <thead>
                        <tr>
                            <th></th>
                            <th>@Html.Translate("Warehouse", "ArticleCode")</th>
                            <th>@Html.Translate("Warehouse", "Description")</th>
                            <th>@Html.Translate("Warehouse", "Availability")</th>
                        </tr>
                    </thead>
                    <tfoot style="display: none">
                        <tr>
                            <th>@Html.Translate("Shared", "All")</th>
                            <th>@Html.Translate("Shared", "All")</th>
                            <th>@Html.Translate("Shared", "All")</th>
                            <th>@Html.Translate("Shared", "All")</th>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
    </div>
</div>


<div class="homeLoading" style="display:none;text-align:center;">
    <i class="fa fa-refresh fa-spin" style="font-size:150px;margin-top:100px;margin-bottom:50px;"></i><br /><br />
    <span id="homeLoadingSpan" style="font-size:20px;"></span>
</div>
<div id="details" style="display:none">

</div>

@section scripts {
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBMeazn6VUFFvSv3ksC7tMGp_-TL86-jNY" async defer></script>
    <script type="text/javascript">

        function changeMode(item) {
            var type = $(item).attr("data-type");
            $("#type_CodiceArticoloText").attr("data-type", type);
            $("#type_CodiceArticoloText").attr("data-type", type).html($("a", item).html() + "<span class='fa fa-caret-down'></span>");
            debugger;
        }
        function searchWarehouse_OnBegin() {
            $("#homeLoadingSpan").html("@Html.Translate("Shared", "Loading")");
            $(".homeLoading").show();

        }

        function searchWarehouse_OnComplete(data, a, b) {
            $(".homeLoading").hide();
            $("#results").html(data);
        }

        var dt;

                function guid() {
                    function s4() {
                        return Math.floor((1 + Math.random()) * 0x10000)
                            .toString(16)
                            .substring(1);
                    }
                    return s4() + s4() + '-' + s4() + '-' + s4() + '-' + s4() + '-' + s4() + s4() + s4();
                }

    $(document).ready(function () {


        $("#btn_search").click(function () {
            $("#results").hide();
            $("#searchId").val(guid());
            $("#homeLoadingSpan").html("@Html.Translate("Shared", "Loading")");
            $(".homeLoading").show();
            dt.fnSort([1, "asc"]);
        });

        dt = $('#resultsTable')
                .dataTable({

                    "language": { "url": "@Html.DataTablesUrl()" },
                    buttons: [],
                    "bFilter": false,
                    "iDisplayLength": 25,
                    "bLengthChange": true,
                    "deferLoading": "0",
                    "bDeferLoading":true,
                    "bPaginate" : true,
                    "bProcessing": false,
                    "bServerSide": true,
                    "searchDelay": 1000,
                    "aaSorting": [[1, "asc"]],
                    "sAjaxSource": "/Warehouse/GetResults",
                    "fnServerData": function (url, data, callback) {

                        data.push({ "name": "searchId", "value": $("#searchId").val() });
                        data.push({ "name": "MCU", "value":"" });
                        data.push({ "name": "Availability", "value": $("#Availability").val() });
                        data.push({ "name": "CodiceArticolo", "value": $("#CodiceArticolo").val() });
                        data.push({ "name": "Descrizione", "value": $("#Descrizione").val() });
                        data.push({ "name": "Categoria1", "value": $("#Categoria1").val() });
                        data.push({ "name": "Categoria2", "value": $("#Categoria2").val() });
                        data.push({ "name": "Categoria3", "value": $("#Categoria3").val() });
                        data.push({ "name": "Categoria4", "value": $("#Categoria4").val() });
                        $.ajax({
                            "url": url,
                            "data": data,
                            "success": function (a, b, c, d) {
                                if (a.Message) {
                                    $("#scheduleCache").val("1");
                                    $(".appLoading").hide();
                                    $(".appLoaded").show();
                                    var now = moment();
                                    $(".dispatchDate").data("DateTimePicker").date(now.add(1, 'hours').add(now.minutes() * -1, 'minutes'));
                                    $("#appMode").val("schedule");
                                    $("#appMode").trigger("change");
                                    $("#appointment_table_wrapper").hide();
                                    $("#lbl_dispatch_message").html(a.Message);
                                    $("#lbl_dispatch_message_container").show();
                                    $("#lbl_dispatch_message_container").removeClass("alert-danger");
                                    $("#lbl_dispatch_message_container").removeClass("alert-warning");
                                    $("#btn_confirm_schedule").hide();
                                    debugger;
                                    try {
                                        if (a.Class) {
                                            $("#lbl_dispatch_message_container").addClass(a.Class);
                                            if (a.Class == "alert-warning") {
                                                $("#btn_confirm_schedule").show();
                                                callback(a, b, c, d);
                                            }
                                        }
                                    }
                                    catch (ex) {
                                        $("#lbl_dispatch_message_container").addClass("alert-danger");
                                    }

                                }
                                else {
                                    callback(a, b, c, d);
                                }
                            },
                            "contentType": "application/x-www-form-urlencoded; charset=utf-8",
                            "dataType": "json",
                            "type": "POST",
                            "cache": false,
                            "error": function () {
                                if (err.status == 403) {
                                    window.location.href = "/Account/Login?expired=true";
                                    return;
                                }
                                alert("DataTables warning: JSON data from server failed to load or be parsed. " +
                                    "This is most likely to be caused by a JSON formatting error.");
                            }
                        });
                    },
                    //"oLanguage": {
                    //    "sProcessing": "<img src='/Content/ImgKOS/ajax-loader.gif' alt='Loading..'/>"
                    //},
                    "aoColumns": [
                            {
                                "sType": "string", "mData": "id",
                                "sClass": "center",
                                "bSortable": false,
                            "mRender": function (objId, type, full) {
                                var id = full.id;
                                var searchId = $("#searchId").val();
                                var link = "<span onclick=\"getDetail(" + id + ",'" + searchId +"')\" class=\"btn btn-primary\">@Html.Translate("Warehouse","Details")</span>";
                                    return link;
                                }

                            }, //Command
                        { "sType": "string", "sName": "CodiceArticolo", "mData": "CodiceArticolo", "bSortable": true }, //CodiceArticolo
                        { "sType": "string", "sName": "Descrizione", "mData": "Descrizione", "bSortable": true }, //Descrizione
                        { "sType": "string", "sName": "Disponibilita", "mData": "Disponibilita", "bSortable": true } //Prova
                    ],
                    fnDrawCallback: function () {
                        $(".homeLoading").hide();
                        $("#results").show();
                        /*
                        $("#scheduleCache").val("1");
                        var rows = this.fnGetData();
                        $(".appLoading").hide();
                        $(".appLoaded").show();
                        var now = moment();
                        $(".dispatchDate").data("DateTimePicker").date(now.add(1, 'hours').add(now.minutes() * -1, 'minutes'));
                        $("#appMode").val("schedule");
                        $("#appMode").trigger("change");
                        $("#appointment_table_wrapper").show();
                        */
                    }
                });

        initAutocompleteCodiceArticolo("#CodiceArticoloText", "#CodiceArticolo", "@Html.Translate("Shared", "NoResults")");
        initAutocompleteDescrizioneArticolo("#DescrizioneText", "#Descrizione", "@Html.Translate("Shared", "NoResults")");

        $("#Categoria1").change(function () {
            var value = $(this).val();
            if (value == "") {
                debugger;
                clearNextDDL();
            }
            else {
                $("#loading_cat_2").html("<i class='fa fa-refresh fa-spin' style='font-size: 20px;line-height:34px;margin-left:5px;'></i>");
                execDataQueryForDDL("Categoria2");
            }
        });
        $("#Categoria2").change(function () {
            var value = $(this).val();
            if (value == "") {
                clearNextDDL();
            }
            else {
                $("#loading_cat_3").html("<i class='fa fa-refresh fa-spin' style='font-size: 20px;line-height:34px;margin-left:5px;'></i>");
                execDataQueryForDDL("Categoria3");
            }
        });
        $("#Categoria3").change(function () {
            var value = $(this).val();
            if (value == "") {
                clearNextDDL();
            }
            else {
                $("#loading_cat_4").html("<i class='fa fa-refresh fa-spin' style='font-size: 20px;line-height:34px;margin-left:5px;'></i>");
                execDataQueryForDDL("Categoria4");
            }
        });
    });

        function getDetail(id, searchId) {
            $("#searchForm").hide();
            $("#homeLoadingSpan").html("@Html.Translate("Shared", "Loading")");
            $(".homeLoading").show();
            $.get("/Warehouse/Details?id=" + id + "&searchId=" + searchId, function (data) {
                $("#details").html(data);
                $(".homeLoading").hide();
                $("#details").show();
            });
        }

        function goHome() {
            $("#details").hide();
            $("#searchForm").show();
        }

    function execDataQueryForDDL(mode) {
        var cat1 = $("#Categoria1").val();
        var cat2 = $("#Categoria2").val();
        var cat3 = $("#Categoria3").val();

        $.getJSON("/Warehouse/GetDDL?cat1=" + cat1 + "&cat2=" + cat2 + "&cat3=" + cat3 + "&mode=" + mode, function (data) {
            $("#" + mode).html("");
            $("#" + mode).append("<option value=''>@Html.Translate("Shared","All")</option>");
            $(data).each(function (i, item) {
                $("#" + mode).append("<option value='" + item.Key +"'>" + item.Value +"</option>")
            });

            if (mode == "Categoria4") {
                $("#loading_cat_4").html("");
            }
            if (mode == "Categoria3") {
                $("#loading_cat_3").html("");
            }
            if (mode == "Categoria2") {
                $("#loading_cat_2").html("");
            }

            clearNextDDL();
        });


    }

    function clearNextDDL() {
        var cat1 = $("#Categoria1").val();
        var cat2 = $("#Categoria2").val();
        var cat3 = $("#Categoria3").val();

        if ((cat1 == "") || (cat1==undefined) || (cat1==null)) {
            $("#Categoria2").html("<option value=''>@Html.Translate("Shared","All")</option>");
            $("#Categoria3").html("<option value=''>@Html.Translate("Shared","All")</option>");
            $("#Categoria4").html("<option value=''>@Html.Translate("Shared","All")</option>");
        }
        else {
            if ((cat2 == "") || (cat2 == undefined) || (cat2 == null)) {
                $("#Categoria3").html("<option value=''>@Html.Translate("Shared","All")</option>");
                $("#Categoria4").html("<option value=''>@Html.Translate("Shared","All")</option>");
            }
            else {
                if ((cat3 == "") || (cat3 == undefined) || (cat3 == null)) {
                    $("#Categoria4").html("<option value=''>@Html.Translate("Shared","All")</option>");
                }
            }
        }

    }
    </script>
}
